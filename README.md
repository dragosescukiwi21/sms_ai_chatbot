# SMS Bot with Dialogflow CX Integration

A Flask-based SMS bot solution that supports Person-to-Person messaging integrating Google's Dialogflow CX. The application works by setting up an Automate (by LlamaLab) flow that reads messages, forwards them via a HTTP webhook and it sends back a message generated by Dialogflow CX.

## Features

- **Compehensive Interface**: A sleek interface to view incoming-outgoing messages. Allows for paused AI responses for a specific phone number
- **SMS Webhook Handler**: Receives incoming SMS messages via HTTP webhook
- **Dialogflow CX Integration**: Uses Google's Dialogflow CX for natural language processing
- **Docker Support**: Containerized for easy deployment
- **Health Check**: Built-in health monitoring endpoint
- **Logging**: Comprehensive logging for debugging and monitoring

## Prerequisites

- Docker / Docker Compose
- Google Cloud Project with Dialogflow CX enabled
- Google service account credentials JSON file
- Automate Application by Llama Lab (both phone and server should be connected to the same network)
- A supabase project

## Configuration

### Environment Variables

The application uses the following configuration (modify in `sms_bot_script.py`):

- `SUPABASE_URL`: Project URL
- `SUPABASE_KEY`: Project API key
- `DIALOGFLOW_PROJECT_ID`: Your Google Cloud project ID
- `AGENT_ID`: Your Dialogflow CX agent ID
- `LOCATION`: Google Cloud region for your Dialogflow CX agent
- `FLASK_PORT`: Port for the Flask application (default: 5000)
- `GOOGLE_APPLICATION_CREDENTIALS`: Path to JSON credentials file (create a service in Cloud Run, set it up and download the key)

### Supabase set-up

1. Create a project on Supabase and set up your API key and URL 
2. Create a `conversations` database in your project containing `sender`, `incoming_msg`, `outgoing_msg` and `phoneid` for text columns. `phoneid` refers to the phone's Android ID from which the messages are being sent.
2. Create a `ai_status` with `phone_number` (text), `is_active` (bool) for columns. This refers to the `phone_number`'s ability to generate and send AI responses. If the AI response is turned off, the interface will display an empty message blob and the phone will not send any message.

### Automate set-up

1. Download sms_bot.flo and the `Automate` application from the Play Store.
2. Give all permissions to the app and start the flow. If you wish to loop this process and listen for SMS indefinitely, you may have to connect the `SMS Send` "Ok" parameter to the `SMS Incoming` "In" parameter   

## Quick Start with Docker

1. Clone this repository
2. Ensure your Google Cloud credentials JSON file is in the project directory
3. Update the configuration variables in `sms_bot_script.py`
4. Build and run with Docker Compose:

```bash
docker-compose up -d
```

The bot will be available at `http://localhost:5000`

## Manual Installation

1. Install Python dependencies:
```bash
pip install -r requirements.txt
```

3. Run the application:
```bash
python sms_bot_script.py
```

## API Endpoints

### POST /sms
Webhook endpoint for receiving SMS messages.

**Request Body:**
```json
{
  "from": "+1234567890",
  "message": "Hello bot!",
  "phoneid": "40385830EAB10K"
}
```

**Response:**
```json
{
  "reply": "Dialogflow CX bot response"
}
```

### GET /health
Health check endpoint for monitoring.

**Response:**
```json
{
  "status": "healthy",
  "service": "sms-bot"
}
```

## Logs

Application logs are stored in the `logs/` directory and include:
- Incoming SMS messages
- Dialogflow CX responses
- Error messages and exceptions

## Security Notes

- The application runs as a non-root user in the Docker container
- Google Cloud credentials should be kept secure and not committed to version control
- Consider using environment variables for sensitive configuration

## License

This project is provided as-is for educational and development purposes.
